# nginx.conf

# --------------------------------------------------------------------------------
# 全局配置 (main context)
# 这些指令影响 Nginx 服务器的整体行为。
# --------------------------------------------------------------------------------

# worker_processes 指令设置工作进程的数量。
# - 'auto' (推荐): Nginx 会根据 CPU 核心数自动设置工作进程数量。
#                 每个工作进程处理独立的请求，利用多核 CPU 的并行计算能力。
#                 通常设置为 CPU 核心数，以达到最佳性能。
worker_processes auto;

# --------------------------------------------------------------------------------
# 事件模型配置 (events context)
# 这些指令配置 Nginx 处理连接的方式。
# --------------------------------------------------------------------------------

events {
    # worker_connections 指令设置每个工作进程可以同时处理的最大连接数。
    # - 1024: 表示每个工作进程可以同时保持 1024 个活动连接。
    #         总的最大连接数 = worker_processes * worker_connections。
    #         这个值通常需要根据服务器的内存和操作系统限制来调整。
    worker_connections 1024;
}

# --------------------------------------------------------------------------------
# HTTP 服务器配置 (http context)
# 这是 Nginx 最核心的配置，用于定义 HTTP 协议相关的行为。
# 所有的 server 块（虚拟主机）都必须在 http 块内。
# --------------------------------------------------------------------------------

http {
    # include 指令用于包含其他配置文件。
    # - 'mime.types': Nginx 会从这个文件中加载 MIME 类型到文件扩展名的映射，
    #                例如 .html 文件是 text/html，.png 文件是 image/png。
    #                这对于正确地向浏览器发送文件内容类型非常重要。
    include       mime.types;
    # default_type 指令设置当 Nginx 无法根据文件扩展名确定 MIME 类型时的默认类型。
    # - 'application/octet-stream': 表示任意二进制数据。这是一种通用的 MINE 类型。
    default_type  application/octet-stream;

    # sendfile 指令开启或关闭 sendfile 系统调用。
    # - 'on': 开启 sendfile。这允许 Nginx 直接在文件描述符之间传输数据，
    #         而不需要通过用户空间，提高了静态文件传输的效率。
    sendfile        on;

    # keepalive_timeout 指令设置保持活动连接的超时时间。
    # - 65: 客户端和服务器之间的 TCP 连接在 65 秒内没有活动，Nginx 将关闭连接。
    #       这减少了建立和拆除连接的开销，从而提高了性能。
    keepalive_timeout  65;

    # ------------------------------------------------------------------------
    # upstream 块: 定义后端服务器组 (负载均衡目标)
    # ------------------------------------------------------------------------

    # upstream 指令定义了一个上游服务器组，Nginx 可以将请求代理到这个组中的服务器。
    # - 'backend_api': 这是这个上游服务器组的名称。在后面的 proxy_pass 中会引用它。
    upstream backend_api {
        # 'server' 指令定义了上游服务器组中的一个成员。
        # - 'backend:5000':
        #   - 'backend': 这是你的 Flask 应用容器在 Docker 网络中的服务名称。
        #                在 Docker Compose 中，服务名称会作为 DNS 名称解析为容器的 IP 地址。
        #                Nginx 容器和 Flask 容器在同一个 Docker 网络中，可以通过服务名称互相访问。
        #   - '5000': 这是 Flask 容器内部监听的端口。
        # 作用: Nginx 将会把发送到 'backend_api' 上游组的请求，转发给 'backend' 服务容器的 '5000' 端口。
        server backend:5000;
        # 如果有多个 Flask 容器，可以添加多行 server 指令，Nginx 会自动进行负载均衡。
        # server backend2:5000;
        # server backend3:5000;
    }

    # ------------------------------------------------------------------------
    # server 块: 定义虚拟主机 (Virtual Host)
    # ------------------------------------------------------------------------

    # server 块定义了一个虚拟主机，用于处理特定的请求。
    # 一个 Nginx 可以配置多个 server 块来处理不同的域名或端口。
    server {
        # listen 指令指定 Nginx 监听的 IP 地址和端口。
        # - 80: Nginx 将监听所有可用 IP 地址的 80 端口，用于接收 HTTP 请求。
        #       这是外部用户访问 Nginx 的入口。
        listen 80;
        # server_name 指令定义此虚拟主机响应的域名。
        # - 'localhost': 表示这个虚拟主机将响应访问 'localhost' 的请求。
        #                在实际部署中，这里会是你的实际域名（如 'example.com'）。
        server_name localhost;

        # --------------------------------------------------------------------
        # location 块: 定义请求的路由规则 (URL 匹配)
        # --------------------------------------------------------------------

        # location / {} 块处理所有以 '/' 开头的请求（即所有请求）。
        # 通常用于处理默认的请求，包括静态文件服务或作为反向代理的默认目标。
        location / {
            # root 指令指定静态文件的根目录。
            # - '/usr/share/nginx/html': Nginx 容器内默认存放静态文件的地方。
            #                       这通常包含你的前端应用（如 React/Vue 项目的 build 产物）。
            root   /usr/share/nginx/html;
            # index 指令定义默认索引文件的名称。
            # 当请求一个目录时（例如 /），Nginx 会尝试在该目录中查找这些文件。
            # - 'index.html index.htm': 优先查找 index.html，如果找不到再找 index.htm。
            index  index.html index.htm;
            # try_files 指令是一个重要的配置，用于处理文件不存在的情况。
            # - '$uri': 尝试查找与 URL 路径完全匹配的文件或目录。例如http://baidu.com/picture.png
            # - '$uri/': 如果 $uri 是一个目录，尝试在该目录中查找索引文件（由 index 指令定义）。
            #   例如http://baidu.com/extra/, 则会尝试查找 /extra/index.html 或 /extra/index.htm。
            # - '/index.html': 如果以上两者都找不到，则将请求重写到 /index.html 文件。
            #   这个配置对单页应用 (SPA,如 Vue/React) 至关重要。SPA 通常只有一个 HTML 页面，
            #   客户端路由在浏览器端完成。当用户直接访问像 `/about` 这样的非根路径时，
            #   服务器需要返回 `index.html`，让前端路由接管。
            #   mpa (多页应用) 则不需要这个配置，可以直接返回 404。
            try_files $uri $uri/ /index.html;
        }

        # location /api {} 块处理所有以 '/api' 开头的请求。
        # 这通常用于将 API 请求转发到后端服务。
        location /api {
            # proxy_pass 指令将请求代理到指定的上游服务器或 URL。
            # - 'http://backend_api': 将请求转发给之前定义的 'backend_api' 上游服务器组。
            #                         Nginx 会自动将请求转发到该组中的一个后端服务器 (backend:5000)。
            #                         注意这里直接使用了 'http://backend_api' 而不是 'http://backend:5000'，
            #                         是因为 upstream 块提供了一个抽象层，更便于管理多个后端实例。
            proxy_pass http://backend_api;
            # proxy_set_header 指令用于在转发请求到后端服务器时，修改请求头。
            # 这些头信息对于后端应用正确识别请求来源、协议等非常重要。
            # - 'Host $host': 设置 Host 请求头为客户端发来的 Host 头。
            #                 这使得后端服务能识别是哪个域名发来的请求 (例如，当后端部署在多个域名背后时)。
            # - 'X-Real-IP $remote_addr': 传递客户端的真实 IP 地址给后端。
            #                          $remote_addr 是 Nginx 获取到的客户端 IP。
            # - 'X-Forwarded-For $proxy_add_x_forwarded_for': 传递一个包含客户端 IP 和所有经过的代理 IP 的列表。
            #                                              $proxy_add_x_forwarded_for 是 Nginx 自动生成的。
            # - 'X-Forwarded-Proto $scheme': 传递请求使用的协议（HTTP 或 HTTPS）给后端。
            #                             $scheme 是 Nginx 获取到的请求协议。
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --------------------------------------------------------------------
        # 错误页面配置
        # --------------------------------------------------------------------

        # error_page 指令定义当 Nginx 遇到特定的 HTTP 错误代码时，如何处理。
        # - '500 502 503 504': 当 Nginx 产生这些内部服务器错误时（通常是后端服务问题）。
        # - '/50x.html': 将请求重定向到内部的 /50x.html 页面。
        error_page   500 502 503 504  /50x.html;
        # location = /50x.html {} 块专门处理对 /50x.html 的请求。
        # - '=' 匹配器表示精确匹配。
        location = /50x.html {
            # root 指令指定 /50x.html 文件所在的根目录。
            root   /usr/share/nginx/html;
        }
    }
}